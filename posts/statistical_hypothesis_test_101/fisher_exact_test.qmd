---
title: "Fisher's exact test"
jupyter: python3
author: "Ryo Nakagami"
date: "2024-09-05"
date-modified: last-modified
comments:
    utterances:
         repo: RyoNakagami/statistics-for-regression-monkey
         label: discussion
# when you run this file locally, do not forget to run poetry shell
---

## $2\times 2$ã‚¯ãƒ­ã‚¹ã‚»ãƒ«è¡¨ã¨Fisher's exact test

<div class="blog-custom-border">
<strong>å•é¡Œè¨­å®š</strong> <br>

ã‚ã‚‹åŒ»è–¬å“è©¦é¨“ã®RCTã«ã¦ï¼Œï¼•ï¼äººã®æ‚£è€…ã‚’ç„¡ä½œç‚ºã«treatedã¨ãƒ—ãƒ©ã‚»ãƒœ(control)ã«åˆ†ã‘ã¦ï¼Œä¸€å®šæœŸé–“å¾Œã®å¥åº·çŠ¶æ…‹(Positive vs Negative)ã‚’ç¢ºèªã—ãŸã¨ã“ã‚
ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã«ãªã£ãŸï¼


<table><thead><tr><th colspan="1" rowspan="2" style="border-width: 1px; width: 350px; text-align: center;"><p style="text-align: center;"><span>&nbsp;</span></p>


</th></tr><tr><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treated</font></font></span></p>
</th><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control</font></font></span></p>
</th><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆè¨ˆ</font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Positive</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>15</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">36</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Negative</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>10</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆè¨ˆ</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">25</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>25</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>


</td></tr></tbody></table>

ã“ã®ã¨ãï¼Œãƒ—ãƒ©ã‚»ãƒœã¨ã‚°ãƒ«ãƒ¼ãƒ—ã¨åŒ»è–¬å“æŠ•å…¥ã‚°ãƒ«ãƒ¼ãƒ—é–“ã§å¥åº·çŠ¶æ…‹åˆ†å¸ƒãŒç•°ãªã‚‹ã‹ã©ã†ã‹æ¤œå®šã—ãŸã„ï¼

</div>
<br>

å„ã‚°ãƒ«ãƒ¼ãƒ—ã®åˆè¨ˆã¨ã„ã†å‘¨è¾ºã®å€¤ãŒå›ºå®šã•ã‚Œã¦ã„ã‚‹ã¨è€ƒãˆãŸã¨ãï¼Œ`(Treated, Positive)`ã®äººæ•°ã¨ã„ã†ç¢ºç‡å¤‰æ•°ãŒå¾“ã†åˆ†å¸ƒã¯è¶…å¹¾ä½•åˆ†å¸ƒã¨ã¿ãªã™ã“ã¨ãŒã§ãã‚‹ï¼
ã¤ã¾ã‚Šï¼Œ

<table><thead><tr><th colspan="1" rowspan="2" style="border-width: 1px; width: 350px; text-align: center;"><p style="text-align: center;"><span>&nbsp;</span></p>


</th></tr><tr><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treated</font></font></span></p>
</th><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control</font></font></span></p>
</th><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆè¨ˆ</font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Positive</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$X_{11}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$X_{12}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{1\cdot}$</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Negative</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$X_{21}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$X_{22}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{2\cdot}$</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆè¨ˆ</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{\cdot 1}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$x_{\cdot 2}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$N$</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>


</td></tr></tbody></table>

ã¨ã—ãŸã¨ãï¼Œ$X_{11}$ã®ç¢ºç‡ã¯

$$
\begin{align*}
\Pr(X_{11}=x) &= \frac{{}_{x_{1\cdot}}C_{x}\times {}_{x_{2\cdot}}C_{x_{\cdot 1} - x} }{{}_{N}C_{x_{\cdot 1}}}\\
              &= \frac{x_{\cdot 1}!x_{\cdot 2}!x_{2\cdot}!x_{2\cdot}!}{x_{11}!x_{12}!x_{21}!x_{22}!N!}
\end{align*}
$$

ã“ã®ã¨ãï¼Œ$x$ ã®ç¯„å›²ã¯ $\max(0, x_{1\cdot} - x_{2\cdot}) \leq x \leq \min(x_{1\cdot}, x_{\cdot 1})$ ã«ãªã‚‹ï¼

<strong > &#9654;&nbsp; Null hypothesis vs Alternative hypothesis</strong>

ä¸Šè¨˜ã®å•é¡Œè¨­å®šã«ãŠã‘ã‚‹Fisher's exact testã«ãŠã‘ã‚‹æ¤œå®šä»®èª¬è¨­å®šä¾‹ã¯ã¨ï¼Œä¸¡å´æ¤œå®šãªã‚‰ã°

- $H_0$: å‡¦ç½®(Treatment)ã¨ä¸€å®šæœŸé–“å¾Œã®å¥åº·çŠ¶æ…‹(ä¸»è¦è©•ä¾¡é …ç›®)ã¯ç‹¬ç«‹
- $H_1$: å‡¦ç½®(Treatment)ã¨ä¸€å®šæœŸé–“å¾Œã®å¥åº·çŠ¶æ…‹(ä¸»è¦è©•ä¾¡é …ç›®)ã¯ç‹¬ç«‹ã§ã¯ãªã„ $\Rightarrow \Pr(\text{Positive}\vert \text{Treated})\neq \Pr(\text{Positive}\vert \text{Control})$

$H_0$ã®ä»®å®šã®ä¸‹ã§ã¯ï¼Œ$X_{11}$ã¯è¶…å¹¾ä½•åˆ†å¸ƒ(hypergeometric distribution)ã«å¾“ã†ã¯ãšãªã®ã§ï¼Œã“ã®ä»®å®šã«åŸºã¥ã„ã¦På€¤ã‚’è¨ˆç®—ã—ã¾ã™ï¼ä¸¡å´æ¤œå®šã§ã®På€¤ã®è¨ˆç®—æ–¹æ³•ä¾‹ã¨ã—ã¦

$$
\begin{align*}
\text{p-value} = \sum_{x} \Pr(X_{11}={x}) \text{ s.t } \{x \vert \Pr(X_{11}={x}) \leq \Pr(X_{11}={x_{11}})\}
\end{align*}
$$


:::{#example-p-value}
```{python}
#| code-fold: true
#| label: hypergeo-dist
import math
import numpy as np
import polars as pl
import plotly.express as px


def compute_prob(
    x: int, positive: int, negative: int, treated: int, denom: int
) -> np.float64:
    return math.comb(positive, x) * math.comb(negative, treated - x) / denom


DENOM = math.comb(50, 25)
X_DOMAIN = np.arange(11, 25)

prob = list(
    map(
        lambda x: compute_prob(x, positive=36, negative=14, treated=25, denom=DENOM),
        X_DOMAIN,
    )
)

# create polars.DataFrame
df = pl.DataFrame({"x": X_DOMAIN, "prob": prob})

# plotly
fig = px.bar(df, x="x", y="prob", title="Null hypothesisä¸‹ã«ãŠã‘ã‚‹ç¢ºç‡åˆ†å¸ƒ")
fig.update_layout(
    xaxis_title="Treatedã«ãŠã‘ã‚‹Positiveã®äººæ•°", yaxis_title="probability"
)

fig.show()
```
:::

### exact p-valueã®è¨ˆç®—

<strong > &#9654;&nbsp; ç‰‡å´æ¤œå®š</strong>

$X_{11} \geq x$ ã¨ãªã‚‹å ´åˆã®p-valueã‚’`scipy.stats.fisher_exact`ã§è¨ˆç®—ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼

```{python}
#| code-fold: false
from scipy.stats import fisher_exact
table = np.array([[21, 15], [4, 10]])
res_greater = fisher_exact(table, alternative='greater')
print("scipy-p-value: {:.6f}".format(res_greater.pvalue))
```

ä¸€æ–¹ï¼Œ[ä¸Šã§è¨ˆç®—ã—ãŸprobability](#example-p-value)ã«å‰‡ã£ã¦ä¸Šå´ç¢ºç‡ã‚’è¦‹ã¦ã¿ã‚‹ã¨


```{python}
#| code-fold: false
print("self-computed-pvalue: {:.6f}".format(df.filter((pl.col("x") >= 21))['prob'].sum()))
```

ã¨æ•°å€¤è¨ˆç®—èª¤å·®ã‚’ç„¡è¦–ã—ã¦ã—ã¾ãˆã°å¤§ã¾ã‹ã«ä¸€è‡´ã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ï¼

<strong > &#9654;&nbsp; ä¸¡å´æ¤œå®š</strong>

ä¸¡å´æ¤œå®šã«ãŠã‘ã‚‹p-valueã¯

$$
\begin{align*}
\text{p-value} = \sum_{x} \Pr(X_{11}={x}) \text{ s.t } \{x \vert \Pr(X_{11}={x}) \leq \Pr(X_{11}={x_{11}})\}
\end{align*}
$$

ãªã®ã§

```{python}
# | code-fold: false
threshold = df.filter((pl.col("x") == 21))["prob"].to_numpy()[0]
res_twosided = fisher_exact(table, alternative="two-sided")
myres_twosided = df.filter((pl.col("prob") <= threshold))["prob"].sum()
print("""scipy-p-value: {:.6f},self-computed-pvalue: {:.6f}
      """.format(res_twosided.pvalue, myres_twosided))
```

ã©ã¡ã‚‰ã®è¨ˆç®—ã§ã‚‚ãŠã‚ˆã $11.37\%$ ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ï¼

<div class="blog-custom-border">
<strong >ğŸ“˜ REMARKS</strong> <br>

- çµ„ã¿åˆã‚ã›ã®æ•°ãŒå¤§ãã™ãï¼Œexact p-valueã®è¨ˆç®—ãŒé›£ã—ã„å ´åˆã¯Monte Carloæ³•ã‚’ç”¨ã„ã¦è¨ˆç®—ã—ã¾ã™

+-----------+---+---+---+---+---+---+---+---+---+---+
| Treatment | T | T | T | T | T | C | C | C | C | C |
+-----------+---+---+---+---+---+---+---+---+---+---+
| Promoted  | 1 | 1 | 1 | 1 | 0 | 1 | 1 | 0 | 0 | 0 | 
+-----------+---+---+---+---+---+---+---+---+---+---+

ã¨ã„ã†Treatedã®ã†ã¡ï¼”äººãŒPromotedã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚ŒãŸå ´åˆï¼ŒTreatedã‹ã¤Promotedã®äººæ•°ã‚’ $X$ ã¨ã—ãŸã¨ãï¼Œ
$\Pr(X \geq 4)$ ã®ã¤ã„ã¦è¨ˆç®—å‚ã™ã‚‹å ´åˆã¯

+-----------+---+---+---+---+---+---+---+---+---+---+
| Treatment | T | T | T | T | T | C | C | C | C | C |
+-----------+---+---+---+---+---+---+---+---+---+---+
| Promoted  | 1 | 0 | 1 | 0 | 0 | 1 | 1 | 1 | 1 | 1 | 
+-----------+---+---+---+---+---+---+---+---+---+---+

ã®ã‚ˆã†ã«ï¼’è¡Œç›®ã«ã¤ã„ã¦Permutationã‚’ãƒ©ãƒ³ãƒ€ãƒ ã« $Y$ å›å®Ÿæ–½ã—ã¦ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‹ã‚‰ $\Pr(X \geq 4)$ ã‚’è¨ˆç®—ã—ã¾ã™ï¼ˆä¸Šã®ä¾‹ã§ã¯ $X = 3$ï¼‰ã¨ãªã£ã¦ã„ã‚‹ï¼ã“ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚ŒãŸp-valueã¯fisher's exact p-valueã®Monte Carlo approximationã¨å‘¼ã‚“ã ã‚Šã—ã¾ã™ï¼

</div>



### Odds ratio

`scipy.stats.fisher_exact`ã§ã¯`pvalue`ã®ã»ã‹ã«`statistic`ã¨ã„ã†è¿”ã‚Šå€¤ã‚’ã‚‚ã£ã¦ã„ã¾ã™ï¼

```{python}
# | code-fold: false
print(res_twosided.statistic)
```

ã“ã® 3.5 ã¯ã„ã‚ã‚†ã‚‹odds ratioã§

$$
3.5 = \frac{21 / 4}{15 / 10}
$$

ã§è¨ˆç®—ã•ã‚Œã¾ã™ï¼

<div class="blog-custom-border">
<strong>Def: Odds</strong> <br>

ç¢ºç‡äº‹è±¡ $A$ ã«ã¤ã„ã¦ã® odds ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨ˆç®—ã•ã‚Œã‚‹

$$
\begin{align*}
\text{odds}(A) = \frac{\Pr(A)}{1 - \Pr(A)} = \frac{\Pr(A)}{\Pr(A^c)}
\end{align*}
$$

</div>

oddsã‚’ç”¨ã„ã‚‹ã“ã¨ã§è¡¨ç¾ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ãƒ•ã‚§ã‚¢ãªè³­ã‘ã«ãŠã„ã‘ã‚‹å€ç‡ã®è¨ˆç®—ãŒä¸Šã’ã‚‰ã‚Œã¾ã™ï¼
ä¾‹ã¨ã—ã¦ï¼Œç¢ºç‡äº‹è±¡ A ã«å¯¾ã—ã¦1å††ã‚’è³­ã‘ã‚‹çŠ¶æ³ã‚’è€ƒãˆã¾ã™ï¼ç¢ºç‡äº‹è±¡ A ãŒç™ºç”Ÿã—ãªã‹ã£ãŸã‚‰1å††ã‚’å¤±ã„ï¼Œç¢ºç‡äº‹è±¡ A
ãŒç™ºç”Ÿã—ãŸã‚‰1å††ã¯ã‚­ãƒ¼ãƒ— & x å††ã®ãƒªã‚¿ãƒ¼ãƒ³ã‚’å¾—ã‚‰ã‚Œã‚‹ã¨ã—ã¾ã™ï¼

ã“ã®ã¨ãï¼Œã“ã®è³­ã‘ãŒãƒ•ã‚§ã‚¢ã§ã‚ã‚‹ãŸã‚ã«ã¯ï¼ŒæœŸå¾…åˆ©å¾—ãŒ0ã§ã‚ã‚‹ã“ã¨ãŒå¿…è¦ã§ã™ãŒï¼Œä»¥ä¸‹ã®ã‚ˆã†ã« $x = \text{odds}(A^c)$ ã¨ãƒªã‚¿ãƒ¼ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ãƒ•ã‚§ã‚¢ãªè³­ã‘ã«ãªã‚Šã¾ã™ï¼

$$
\begin{align*}
&\text{expected return} = x \times \Pr(A) + (-1) \times \Pr(A^c)\\
&\Rightarrow x = \frac{\Pr(A^c)}{\Pr(A)} \because \text{exptected return should be 0}\\
& \Rightarrow x = \text{odds}(A^c) = 1/\text{odds}(A) 
\end{align*}
$$

<div class="blog-custom-border">
<strong>Def: Odds ratio</strong> <br>

ã¨ã‚ã‚‹æ¯é›†å›£ã«ãŸã„ã—ã¦ï¼Œã¨ã‚ã‚‹ç–¾æ‚£ã®ç™ºç—‡ã‚’æŠ‘åˆ¶ã™ã‚‹ã¨è¬³ã£ã¦ã„ã‚‹æ–°è–¬ã‚’è€ƒãˆã¾ã™ï¼

- ç–¾æ‚£ãŒç™ºç—‡ã—ãŸãªã‚‰Positive, ç™ºç—‡ã—ãªã‹ã£ãŸã‚‰Negative
- æ–°è–¬ã‚’å‡¦æ–¹ã•ã‚ŒãŸã‚‰Treated, ã•ã‚Œãªã‹ã£ãŸã‚‰Control

ã¨ã—ã¦ï¼Œæ¯é›†å›£ã®å„çµ„ã¿åˆã‚ã›ã«å¯¾ã™ã‚‹äº‹å‰å‰²å½“ç¢ºç‡ãŒä»¥ä¸‹ã®ã‚ˆã†ãªã‚¯ãƒ­ã‚¹ã‚»ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ï¼

<table><thead><tr><th colspan="1" rowspan="2" style="border-width: 1px; width: 350px; text-align: center;"><p style="text-align: center;"><span>&nbsp;</span></p>


</th></tr><tr><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treated</font></font></span></p>
</th><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control</font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Positive</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$p_{11}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$p_{12}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Negative</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$p_{21}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$p_{22}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr></tbody></table>

ã“ã®ã¨ãï¼Œtreated/controlé–“ã®ç–¾æ‚£ç™ºç—‡ã®odds ratioã¯

$$
\text{odds ratio} = \frac{p_{11}p_{22}}{p_{21}p_{12}}
$$

ã§è¡¨ç¾ã•ã‚Œã‚‹ï¼

</div>

<br>

ä»®ã« Treated, Controlä¸¡æ–¹ã®ã‚°ãƒ«ãƒ¼ãƒ—ã§ç–¾æ‚£ç™ºç—‡ãŒãƒ¬ã‚¢ãªã‚¤ãƒ™ãƒ³ãƒˆã ã¨ã™ã‚‹ã¨ $1- \Pr(\text{Positive} \vert \text{Treated}), 1-\Pr(\text{Positive} \vert \text{Control})$ ã¯ã¨ã‚‚ã«ååˆ†å°ã•ããªã‚Šï¼Œ

$$
\text{odds}(\text{Positive}\vert\text{Treated}) \approx Pr(\text{Positive} \vert \text{Treated})
$$ 

ã¨ã¿ãªã›ã‚‹ã®ã§

$$
\frac{\text{odds}(\text{Positive}\vert\text{Treated})}{\text{odds}(\text{Positive}\vert\text{Control})} \approx \frac{Pr(\text{Positive} \vert \text{Treated})}{Pr(\text{Positive} \vert \text{Control})}
$$

Odds ratioãŒ0.7ã ã¨ã™ã‚‹ã¨ï¼ŒTreated ã¯ Controlã«ãã‚‰ã¹ 30% ã»ã©ç–¾æ‚£ç™ºç—‡ç¢ºç‡ãŒä½ã„ã¨ã„ã†è§£é‡ˆã«ç¹‹ãŒã‚Šã¾ã™ï¼

### Odds ratioã®æ¨å®šã¨ä¿¡é ¼åŒºé–“

<table><thead><tr><th colspan="1" rowspan="2" style="border-width: 1px; width: 350px; text-align: center;"><p style="text-align: center;"><span>&nbsp;</span></p>


</th></tr><tr><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treated</font></font></span></p>
</th><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control</font></font></span></p>
</th><th style="border-width: 1px; width: 350px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆè¨ˆ</font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Positive</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{11}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$x_{12}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{1\cdot}$</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Negative</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{21}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$x_{22}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{2\cdot}$</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>

</td></tr><tr><th style="border-width: 1px; width: 233.333px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆè¨ˆ</font></font></span></p>
</th><th style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$x_{\cdot 1}$</font></font></span></p>
</th><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font>$x_{\cdot 2}$</font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>
</td><td style="border-width: 1px; width: 175px; text-align: center;"><p dir="ltr" style="text-align: center;"><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$N$</font></font></span><br><span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"></font></font></span></p>


</td></tr></tbody></table>

ä¸Šè¨˜ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ï¼Œprior odds ratio $\theta$ ã®æ¨å®šã¯

$$
\hat\theta = \frac{\hat p_{11}\hat p_{22}}{\hat p_{21}\hat p_{12}} \  \ \text{where } \hat p_{ij} = \frac{x_{ij}}{N}
$$

å¾“ã£ã¦ï¼Œ

$$
\hat\theta = \frac{x_{11}x_{22}}{x_{21}x_{12}}
$$

<strong > &#9654;&nbsp; Confidence Intervalã®è¨ˆç®—</strong>

Confidence Intervalã¯ï¼Œå®Ÿå‹™ã§ã¯ $\log(\theta)$ ã‚’ç”¨ã„ãŸCLTã¨delta methodã«ã‚ˆã‚‹è¿‘ä¼¼ã§è¨ˆç®—ã•ã‚Œã¾ã™ï¼

$$
\begin{align*}
\mathbf p = (p_{11},p_{12},p_{21},p_{22})
\end{align*}
$$

ã¨ã—ãŸã¨ãï¼Œã‚‚ã¨ã‚‚ã¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚¯ãƒ©ã‚¹4ã®å¤šé …åˆ†å¸ƒã¨ã¿ãªã›ã‚‹ã®ã§ $\mathbf p$ ã«ã¤ã„ã¦ã®å…±åˆ†æ•£è¡Œåˆ— $\Sigma$ ã¯

$$
\begin{align*}
\Sigma = \frac{1}{n}\left(
    \begin{array}{cccc}
    (1-p_{11}) p_{11} & -p_{11} p_{12} & -p_{11} p_{21} & -p_{11} p_{22} \\
     -p_{11} p_{12} & \left(1-p_{12}\right) p_{12} & -p_{12} p_{21} & -p_{12} p_{22} \\
     -p_{11} p_{21} & -p_{12} p_{21} & \left(1-p_{21}\right) p_{21} & -p_{21} p_{22} \\
     -p_{11} p_{22} & -p_{12} p_{22} & -p_{21} p_{22} & (1-p_{22}) p_{22} 
    \end{array}
\right)
\end{align*}
$$

ã¾ãŸï¼Œ$\log(\theta) = \log(p_{11}) - \log(p_{12}) - \log(p_{21}) + \log(p_{22})$ ã«ã¤ã„ã¦ã®åˆ†æ•£ã¯delta methodã‚’ç”¨ã„ã¦

$$
\begin{align*}
&\operatorname{Var}(\log(\mathrm{OR})) = (\nabla f \Sigma )\times \nabla f^T\\
&\nabla f = \left(\frac{1}{p_{11}},-\frac{1}{p_{12}},-\frac{1}{p_{21}},\frac{1}{p_{22}}\right)
\end{align*}
$$

ã¨è¡¨ã›ã¾ã™ï¼ã“ã‚Œã‚’æ¨å®šå€¤ $\hat p_{ij}$ ã‚’ç”¨ã„ã¦è¨ˆç®—ã™ã‚‹ã¨

$$
\begin{align*}
&\widehat{\operatorname{Var}(\log(\operatorname{OR})}=\frac{1}{x_{11}}+\frac{1}{x_{12}}+\frac{1}{x_{21}}+\frac{1}{x_{22}}\\
&\widehat{\operatorname{SE}(\log(\operatorname{OR})}=\sqrt{\frac{1}{x_{11}}+\frac{1}{x_{12}}+\frac{1}{x_{21}}+\frac{1}{x_{22}}}
\end{align*}
$$

$\mathbf p$ ã¯ $N$ ãŒååˆ†å¤§ãã„ã¨ãCLTã‚ˆã‚Šæ­£è¦åˆ†å¸ƒã«è¿‘ä¼¼ã§ãã‚‹ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã®ã§ $\log(\hat\theta)$ ã«ã¤ã„ã¦ã®Confidence Intervalã¯

$$
\text{CI(log odds ratio)} = \widehat{\log(\operatorname{OR})}\pm z_{1-\alpha/2}\times \widehat{\operatorname{SE}(\log(\operatorname{OR})}
$$

ã¾ãŸï¼Œodds ratioã®Confidence Intervalã¯å¯¾æ•°ã‚’å†åº¦å¤‰æ›ã™ã‚Œã°è‰¯ã„ã®ã§

$$
\text{CI(odds ratio)} = \exp(\widehat{\log(\operatorname{OR})}\pm z_{1-\alpha/2}\times \widehat{\operatorname{SE}(\log(\operatorname{OR})})
$$

ã¨è¨ˆç®—ã§ãã‚‹ï¼

<div class="blog-custom-border">
<strong >ğŸ“˜ REMARKS</strong> <br>

- ä¸Šè¨˜ã®æ–¹æ³•ã§ã®Confidence intervalã¯ $\log(\hat\theta)$ è‡ªä½“ã®æ¨å®šåˆ†æ•£ã§ã¯ãªãï¼ŒCLTã‚’ç”¨ã„ã¦ã„ã‚‹ã®ã§ã‚ãã¾ã§åˆ†æ•£ã«ã¤ã„ã¦ã®æ¥µé™åˆ†å¸ƒã‚’ç”¨ã„ã¦ã„ã‚‹
- $p_{21}$ ã‚„ $p_{12}$ è‡ªä½“ã¯0ã«ãªã‚Šå¾—ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ï¼Œ$\hat\theta$ ã‚„ $\log(\hat\theta)$ ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã‚‹ 


</div>


References
----------
- [PennState STAT 504 > 4.5 - Fisher's Exact Test](https://online.stat.psu.edu/stat504/lesson/4/4.5)